---
title: "Detecting cell-type-specific AEI in bulk RNA-seq"
output: 
   html_document:
      number_sections: FALSE
      self_contained: yes
      toc: yes
bibliography: reference.bib
link-citations: yes
---


```{r, echo=FALSE, message=FALSE}
library(knitr)
library(DT)
library(kableExtra)
```

```{r pre, echo=FALSE,message=FALSE}
#library(devtools)
#install_github("cboettig/knitcitations")
#require(knitcitations)
#bib <- read.bibtex("reference.bib")

# install.packages("citr")
#library("citr")
#md_cite("Wang 2019", bib_file = "reference.bib")

#%\VignetteEngine{knitr::rmarkdown}
#%\VignetteIndexEntry{Vignette Title}
#%\VignetteEncoding{UTF-8}
```

This vignette provides a walk through tutorial on how to use `BSCET` to characterize cell-type-specific allelic expression imbalance (AEI), and the association of cell-type-specific AEI with clinical factors by integrative analysis of bulk and single cell RNA sequencing (RNA-seq) data. `BSCET` involves two steps. First, using MuSiC [@music], we infer cell type proportions in the bulk RNA-seq samples by incorporating cell-type-specific gene expression information provided by a scRNA-seq reference. Second, for each heterozugous transcribed SNP, `BSCET` then aggregates allele-specific read counts from the bulk RNA-seq data across individuals to model cell-type-specific expression difference between two alleles by linear regression, and tests for the evidence of cell-type-specific AEI. 

<style>
figure{
  text-align: center;
}
</style>

<figure>
<p align="center"> 
![Figure 1: Overview of BSCET](./Figure.jpg){width="60%"}
</p>
</figure>

Below, using the human pancreas datasets, we demonstrate `BSCET` step by step.

## Step 1: Estimate cell type proportions by deconvolution

Following MuSiC [@music], we deconvolve bulk RNA-seq data of 89 subjects from @fadista using single cell reference obtained from @seger. We constrained our estimation on 6 well-studied cell types: acinar, alpha, beta, delta, ductal and gamma. Both bulk and single cell data used are in the form of ExpressionSet.

```{r step1, message=FALSE}
library(MuSiC)
library(xbioc)
fadista.eset = readRDS("./GSE50244bulkeset.rds")
seger.eset = readRDS("./EMTABesethealthy.rds")
est.prop = music_prop(bulk.eset = fadista.eset, sc.eset = seger.eset, clusters = 'cellType',
                               samples = 'sampleID', select.ct = c('acinar','alpha', 'beta', 'delta','ductal',
                                                                   'gamma'), verbose = F)$Est.prop.weighted
```

Below shows the estimated cell type proportions for each individual.

```{r step1.1, echo=FALSE}
datatable(round(est.prop,3), class = 'cell-border stripe', rownames = TRUE, 
          options = list(pageLength = 5, fixedColumns = T, dom='rtp', pagingType = "numbers",
                         columnDefs = list(list(className = 'dt-center', targets = 0:5))))
```

## Step 2: Detect cell-type-specific AEI

Given the estimated cell type proportions, for each heterozugous transcribed SNP, `BSCET` aggregates allele-specific read counts of the bulk RNA-seq data across individuals and detects cell-type-specific AEI of the SNP. The input allelic bulk RNA-seq data contain columns: 

* `SNP`: character, the name or chromosome location of each heterozygous transcriobed SNP;
* `ref`: numeric, the SNP-level allele-specific read counts of the reference allele;
* `alt`: numeric, the SNP-level allele-specific read counts of the alternative allele;
* `id`: character, individual identifier;

The tables below show an example allelic RNA-seq data of SNP chr1:22336305.

```{r step2, echo=FALSE, message=FALSE}
DATA = read.table('example_data.txt',header=T)
dat = DATA[,c('SNP','id', 'ref','alt')]
datatable(dat, class = 'cell-border stripe', rownames = FALSE, 
          options = list(pageLength = 5, fixedColumns = T, dom='rtp', pagingType = "numbers",
                         columnDefs = list(list(className = 'dt-center', targets = 0:3))))
```

Let $X_j^T$ and $X_j^t$ be the read counts for the reference and alternative alleles of the transcribed SNP, respectively. The difference of two allele-specific reads can be expressed as:

$$X_j^T-X_j^t = \alpha+m_j\sum_{k=1}^Kp_j^k\theta^k+\epsilon_j$$
where the intercept $\alpha$ captures the allelic expression difference not explained by the selected $K$ cell types; $m_j$ captures total number of cells in the bulk tissue for individual $j$; $p_j^k$ represents the cell type proportions of cell type $k$ for individual $j$; $Î¸^k$ represents allelic expression difference between two alleles of the transcribed SNP for cell type $k$; $\epsilon_j$ is the random error term and assumed to follow $N(0,\sigma^2)$. To detect cell-type-specific AEI in the population, for cell type $k$, using t statistic, we test the following hypothesis:

$$H_0: \theta^k=0  \;\; vs \;\;  H_1: \theta^k \neq 0$$
As $m_j$ is not observed for the bulk data, we esimate it using the individual-specific library size factor using DESeq2 [@deseq]. DESeq2 takes the bulk-level gene expression matrix obtained from the ExpressionSet as the input.

```{r deseq, message=FALSE}
library(DESeq2)
expmat <- exprs(fadista.eset)
#
#colnames(expmat) = as.character(colnames(expmat))
coldata = matrix(colnames(expmat),ncol=1)
colnames(coldata) = 'id'
rownames(coldata) = colnames(expmat)
dds <- DESeqDataSetFromMatrix(countData = expmat,
                              colData = coldata,
                              design = ~ id)
dds <- estimateSizeFactors(dds)
mj = sizeFactors(dds)
head(mj)
```

For each individual, calculated $m_jp_j^k$ and combinine it with the allelic count data, we can have the data as the following:

```{r data, echo=FALSE, message=FALSE}
est.prop = est.prop[names(mj),]
mp = cbind('id'=rownames(est.prop),est.prop*mj)
dat = merge(dat, mp, by='id')
dat$acinar = as.numeric(as.character(dat$acinar))
dat$alpha = as.numeric(as.character(dat$alpha))
dat$beta = as.numeric(as.character(dat$beta))
dat$delta = as.numeric(as.character(dat$delta))
dat$ductal = as.numeric(as.character(dat$ductal))
dat$gamma = as.numeric(as.character(dat$gamma))
dat1=dat
dat1[,c('acinar','alpha', 'beta', 'delta','ductal','gamma')] = 
  apply(dat1[,c('acinar','alpha', 'beta', 'delta','ductal','gamma')],2,function(x){round(x,3)})
datatable(dat1, class = 'cell-border stripe', rownames = FALSE, 
          options = list(pageLength = 5, scrollY = '650px', sScrollX='100%', scrollCollapse = TRUE,
                         pagingType = "numbers", dom='rtp',
                         columnDefs = list(list(className = 'dt-center', targets = 0:9))))
```

Then, regressing the difference of two allele-specific read counts over $m_jp_j^k$ through linear regression, we can obtain the p-values of AEI detection for each cell type. As we can see below, the SNP was detected as having cell-type-specific AEI for acinar cells. 

```{r AEI}
mod=lm(ref-alt ~ `acinar`+`alpha`+`beta`+`delta`+`ductal`+`gamma`,data=dat)
p_value = summary(mod)$coefficient[,4][-1]
print(round(p_value,5))
```

## Step 2 extension: Associate cell-type-specific AEI with covariates

We can readily extend the model in step 2 to assess covariate effects on cell-type-specific AEI. Let $V_j$ be the covariate of interest for individual $j$. We can modify the model by adding an interaction term between the covariate and the estimated cell type proportions:

$$X_j^T-X_j^t=\alpha+m_j\sum_{k=1}^Kp_j^k(\theta^k +V_j \theta_{\Delta}^k)+ \epsilon_j$$           
where $\theta_{\Delta}^k$ is the covariate effect on the cell-type-specific AEI. In practice we will likely test for the covariate effect on cell-type-specific AEI only if a cell-type-specific AEI has been detected based on model in step 2. Therefore, here, we are interested in testing whether the cell-type-specific AEI changes with the covariate, i.e., for each cell type $k$, we test the following hypothesis:

$$H_0: \theta_{\Delta}^k=0   \;\; vs \;\;  H_1: \theta_{\Delta}^k\neq 0$$

As the bulk RNA-seq data are from pancreatic islets, here, we test for the effect of HbA1c, a well-known biomarker for T2D diagnosis, on cell-type-specific AEI. By including HbA1c, we can have the data as the following:

```{r data2, echo=FALSE, message=FALSE}
dat = merge(dat,DATA[,c('id','HbA1c')],by='id')
dat$HbA1c = as.numeric(as.character(dat$HbA1c))
dat1=dat
dat1[,c('acinar','alpha', 'beta', 'delta','ductal','gamma','HbA1c')] = 
  apply(dat1[,c('acinar','alpha', 'beta', 'delta','ductal','gamma','HbA1c')],2,function(x){round(x,3)})

datatable(dat1, rownames = FALSE, 
          options = list(pageLength = 5, scrollY = '650px', sScrollX='100%', scrollCollapse = TRUE,
                         pagingType = "numbers", dom='rtp',
                         columnDefs = list(list(className = 'dt-center', targets = 0:10))))
```

Model the difference of two allele-specific read counts over the interaction between HbA1c and the estimated cell type proportions through linear regression, we can obtain the p-values, i.e., the significance, of the effect of HbA1c on cell-type-specific AEI. As we can see below, cell-type-specific AEI was not associated with HbA1c level for all cell types. 

```{r coAEI}
mod=lm(ref-alt ~ `acinar`+`alpha`+`beta`+`delta`+`ductal`+`gamma`+
          HbA1c:(`acinar`+`alpha`+`beta`+`delta`+`ductal`+`gamma`),data=dat)
p_value = summary(mod)$coefficient[,4][8:13]
print(round(p_value,5))
```

***